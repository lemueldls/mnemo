name: "Reusable android workflow"

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ""
      tagName:
        required: false
        type: string
    secrets:
      ANDROID_RELEASE_KEYSTORE:
        required: false
      ANDROID_RELEASE_KEYSTORE_PASSWORD:
        required: false
      ANDROID_RELEASE_KEY:
        required: false
      ANDROID_RELEASE_KEY_PASSWORD:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    name: üì¶üî®
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: üìù Extract version from tauri.conf.json
        id: get-version
        run: |
          CURRENT_VERSION=$(jq -r '.version' platform/tauri/tauri.conf.json)
          echo "current-version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: üõ°Ô∏è Verify tag matches version in tauri config (publish only)
        if: inputs.tagName
        shell: bash
        run: |
          CURRENT_VERSION=${{ steps.get-version.outputs.current-version }}
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" != *"$CURRENT_VERSION" ]]
          then
            echo "The tag name ${TAG} does not match the version ${CURRENT_VERSION} from tauri config"
            exit 1
          fi

      - name: ü¶ÄüöÄ
        uses: ./.github/actions/setup-rust-cache
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android,wasm32-unknown-unknown
          save-cache: ${{ inputs.branch == 'main' }}

      - name: üõ†Ô∏èüöÄ
        if: (!inputs.tagName)
        uses: ./.github/actions/setup-sccache

      - name: ‚òï Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: üõ†Ô∏è Install NDK
        run: sdkmanager "ndk;27.0.11902837"

      - name: üì• Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: üì• Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: üì• Install frontend dependencies
        run: pnpm install

      - name: üîë Extract android signing key
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > platform/tauri/gen/android/app/key.jks
          echo "${{ secrets.ANDROID_KEYSTORE_PROPERTIES }}" | base64 --decode > platform/tauri/gen/android/keystore.properties

      - name: üî® Build app bundle
        run: |
          pnpm tauri android init
          pnpm tauri android build
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.11902837
          NODE_OPTIONS: --max-old-space-size=8192
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          NUXT_PUBLIC_API_BASE_URL: ${{ secrets.NUXT_PUBLIC_API_BASE_URL }}

      - name: üì§ Upload build artifacts (if not publishing)
        if: (!inputs.tagName)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: "signed-apk"
          path: |
            platform/tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk

      - name: ‚úèÔ∏è Rename APK file
        run: |
          mv ./platform/tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk ./platform/tauri/gen/android/app/build/outputs/apk/universal/release/Mnemo_${{ steps.get-version.outputs.current-version }}_universal.apk

      - name: üöÄ Publish (publish only)
        if: inputs.tagName
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: Mnemo Release v${{ steps.get-version.outputs.current-version }}
          append_body: true
          make_latest: false
          generate_release_notes: false
          files: |
            platform/tauri/gen/android/app/build/outputs/apk/universal/release/Mnemo_${{ steps.get-version.outputs.current-version }}_universal.apk

      - name: üõ°Ô∏è Attest build provenance (publish only)
        if: inputs.tagName
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            platform/tauri/gen/android/app/build/outputs/apk/universal/release/Mnemo_${{ steps.get-version.outputs.current-version }}_universal.apk
