name: "Reusable desktop tauri build workflow"

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ""
      tagName:
        required: false
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "ubuntu-latest"
            symbol: üêß
            platform: Linux
            container_image: ghcr.io/lemueldls/mnemo-ubuntu-builder:latest
          - os: "macos-latest"
            args: "--target universal-apple-darwin"
            symbol: üçè
            platform: macOS
          - os: "windows-latest"
            symbol: ü™ü
            platform: Windows

    name: ${{ matrix.symbol }}üî®
    runs-on: ${{ matrix.os }}
    container: ${{ contains(matrix.os, 'ubuntu') && matrix.container_image || null }}
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üìù Extract version from tauri.conf.json
        id: get-version
        shell: bash
        run: |
          CURRENT_VERSION=$(jq -r '.version' platform/tauri/tauri.conf.json)
          echo "current-version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: üõ°Ô∏è Verify tag matches version in tauri config (publish only)
        if: inputs.tagName
        shell: bash
        run: |
          CURRENT_VERSION=${{ steps.get-version.outputs.current-version }}
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" != *"$CURRENT_VERSION" ]]
          then
            echo "The tag name ${TAG} does not match the version ${CURRENT_VERSION} from tauri config"
            exit 1
          fi

      - name: ü¶ÄüöÄ
        uses: ./.github/actions/setup-rust-cache
        with:
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin,wasm32-unknown-unknown' || 'wasm32-unknown-unknown' }}
          save-cache: ${{ inputs.branch == 'main' }}

      - name: üõ†Ô∏èüöÄ
        if: (!inputs.tagName)
        uses: ./.github/actions/setup-sccache

      - name: üîë Import windows signing certificate (windows only)
        if: contains(matrix.os, 'windows')
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          New-Item -ItemType directory -Path certificate
          Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
          certutil -decode certificate/tempCert.txt certificate/certificate.pfx
          Remove-Item -path certificate -include tempCert.txt
          Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)

      - name: üì• Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: üì• Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: üî® Build plain executables using tauri action (publish artifacts on release)
        uses: tauri-apps/tauri-action@73fb865345c54760d875b94642314f8c0c894afa # v0.6.1
        if: ${{ !contains(matrix.os, 'macos') }}
        env:
          NODE_OPTIONS: --max-old-space-size=8192
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tagName }}
          releaseDraft: false
          prerelease: false
          assetNamePattern: "[name]_[version]_[arch][ext]"
          args: ${{ matrix.args }} --no-bundle
          retryAttempts: 1
          uploadPlainBinary: true

      - name: üî® Build bundles using tauri action (publish artifacts on release)
        uses: tauri-apps/tauri-action@73fb865345c54760d875b94642314f8c0c894afa # v0.6.1
        env:
          NODE_OPTIONS: --max-old-space-size=8192
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          updaterJsonPreferNsis: true
          tagName: ${{ inputs.tagName }}
          releaseDraft: false
          prerelease: false
          assetNamePattern: "[name]_[version]_[arch][ext]"
          args: ${{ matrix.args }}
          retryAttempts: 1

      - name: üì§ Upload build artifacts (push or pr builds only)
        if: (!inputs.tagName)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: "bundles-${{matrix.os}}${{matrix.args}}"
          path: |
            platform/target/**/release/bundle
            platform/target/**/release/mnemo*

      - name: üõ°Ô∏è Attest build provenance (publish release only)
        if: inputs.tagName
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            platform/target/release/bundle/nsis/*
            platform/target/**/release/bundle/macos/*.tar.gz*
            platform/target/**/release/bundle/dmg/*.dmg
            platform/target/release/bundle/deb/*.deb
            platform/target/release/bundle/rpm/*.rpm
            platform/target/**/release/mnemo
            platform/target/release/mnemo.exe
