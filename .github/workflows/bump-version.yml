name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to bump
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry-run:
        description: dry-run
        required: true
        type: boolean

jobs:
  update_version:
    permissions:
      actions: write # to trigger other actions
      contents: write # to update version and create tag
    runs-on: ubuntu-slim
    outputs:
      version: ${{ steps.semver.outputs.semantic-version }}
    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - id: semver
        uses: SOLIDSoftworks/semver-tags@fa8963220fb4913aea2b20cc190004de1b79f395 # v1.5.3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}
          tag-prefix: "mnemo-v"
          incremented-value: ${{ inputs.version }}
          create-release: false
          dry-run: true

      - name: âš™ï¸ Set up SSH signing key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_SIGNING_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          git config --global gpg.format ssh
          git config --global user.signingKey ~/.ssh/id_ed25519
          git config --global user.name "Lemuel DLS"
          git config --global user.email "26912197+lemueldls@users.noreply.github.com"

      - name: ğŸ”„ Update cargo and tauri versions
        run: |
          sed -i '0,/\(version *= *\).*/s//\1"${{ steps.semver.outputs.semantic-version }}"/' platform/Cargo.toml
          jq --indent 4 '.version="${{ steps.semver.outputs.semantic-version }}"' platform/tauri/tauri.conf.json > tauri.config.json.new && mv tauri.config.json.new platform/tauri/tauri.conf.json
          sed -i '/name = "mnemo"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' platform/Cargo.lock
          sed -i '/name = "mnemo-wasm"/{N;s/\(version *= *\)".*"/\1"'"${{ steps.semver.outputs.semantic-version }}"'"/;}' platform/Cargo.lock

      - name: ğŸ’¾ğŸ·ï¸â¬†ï¸ Commit, tag and push
        if: ${{ !inputs.dry-run }}
        run: |
          git add -A
          git commit -S -m "chore: bump version to ${{ steps.semver.outputs.semantic-version }}"
          git push
          git tag -s -a mnemo-v${{ steps.semver.outputs.semantic-version }} -m "Mnemo Release v${{ steps.semver.outputs.semantic-version}}"
          git push --tags
